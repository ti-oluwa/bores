<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="3D Three-Phase Black-Oil Reservoir Modelling and Simulation Framework in Python"><meta name=author content=ti-oluwa><link href=https://ti-oluwa.github.io/bores/user-guide/advanced/states-streams/ rel=canonical><link href=../aquifers/ rel=prev><link href=../model-analysis/ rel=next><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.3"><title>States & Streams - BORES</title><link rel=stylesheet href=../../../assets/stylesheets/main.484c7ddc.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=DM+Sans:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"DM Sans";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../stylesheets/extra.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=teal data-md-color-accent=amber> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#states-and-streams class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <div data-md-color-scheme=default data-md-component=outdated hidden> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title=BORES class="md-header__button md-logo" aria-label=BORES data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> BORES </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> States & Streams </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media=(prefers-color-scheme) data-md-color-scheme=default data-md-color-primary=teal data-md-color-accent=amber aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=teal data-md-color-accent=amber aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=teal data-md-color-accent=amber aria-label="Switch to system preference" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to system preference" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/ti-oluwa/bores title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> ti-oluwa/bores </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../../getting-started/ class=md-tabs__link> Getting Started </a> </li> <li class=md-tabs__item> <a href=../../../fundamentals/ class=md-tabs__link> Fundamentals </a> </li> <li class=md-tabs__item> <a href=../../../tutorials/ class=md-tabs__link> Tutorials </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../ class=md-tabs__link> User Guide </a> </li> <li class=md-tabs__item> <a href=../../../visualization/ class=md-tabs__link> Visualization </a> </li> <li class=md-tabs__item> <a href=../../../api-reference/ class=md-tabs__link> API Reference </a> </li> <li class=md-tabs__item> <a href=../../../best-practices/ class=md-tabs__link> Best Practices </a> </li> <li class=md-tabs__item> <a href=../../../examples/ class=md-tabs__link> Examples </a> </li> <li class=md-tabs__item> <a href=../../../reference/glossary/ class=md-tabs__link> Reference </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title=BORES class="md-nav__button md-logo" aria-label=BORES data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> BORES </label> <div class=md-nav__source> <a href=https://github.com/ti-oluwa/bores title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> ti-oluwa/bores </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2> <div class="md-nav__link md-nav__container"> <a href=../../../getting-started/ class="md-nav__link "> <span class=md-ellipsis> Getting Started </span> </a> <label class="md-nav__link " for=__nav_2 id=__nav_2_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Getting Started </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../getting-started/installation/ class=md-nav__link> <span class=md-ellipsis> Installation </span> </a> </li> <li class=md-nav__item> <a href=../../../getting-started/quickstart/ class=md-nav__link> <span class=md-ellipsis> Quick Start </span> </a> </li> <li class=md-nav__item> <a href=../../../getting-started/concepts/ class=md-nav__link> <span class=md-ellipsis> Core Concepts </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3> <div class="md-nav__link md-nav__container"> <a href=../../../fundamentals/ class="md-nav__link "> <span class=md-ellipsis> Fundamentals </span> </a> <label class="md-nav__link " for=__nav_3 id=__nav_3_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Fundamentals </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../fundamentals/reservoir-simulation/ class=md-nav__link> <span class=md-ellipsis> Reservoir Simulation </span> </a> </li> <li class=md-nav__item> <a href=../../../fundamentals/black-oil-model/ class=md-nav__link> <span class=md-ellipsis> The Black-Oil Model </span> </a> </li> <li class=md-nav__item> <a href=../../../fundamentals/grid-systems/ class=md-nav__link> <span class=md-ellipsis> Grid Systems </span> </a> </li> <li class=md-nav__item> <a href=../../../fundamentals/simulation-workflow/ class=md-nav__link> <span class=md-ellipsis> Simulation Workflow </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4> <div class="md-nav__link md-nav__container"> <a href=../../../tutorials/ class="md-nav__link "> <span class=md-ellipsis> Tutorials </span> </a> <label class="md-nav__link " for=__nav_4 id=__nav_4_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Tutorials </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../tutorials/01-first-simulation/ class=md-nav__link> <span class=md-ellipsis> 1. Your First Simulation </span> </a> </li> <li class=md-nav__item> <a href=../../../tutorials/02-building-models/ class=md-nav__link> <span class=md-ellipsis> 2. Building Reservoir Models </span> </a> </li> <li class=md-nav__item> <a href=../../../tutorials/03-waterflood/ class=md-nav__link> <span class=md-ellipsis> 3. Waterflood Simulation </span> </a> </li> <li class=md-nav__item> <a href=../../../tutorials/04-gas-injection/ class=md-nav__link> <span class=md-ellipsis> 4. Gas Injection </span> </a> </li> <li class=md-nav__item> <a href=../../../tutorials/05-miscible-flooding/ class=md-nav__link> <span class=md-ellipsis> 5. Miscible Gas Flooding </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5 checked> <div class="md-nav__link md-nav__container"> <a href=../../ class="md-nav__link "> <span class=md-ellipsis> User Guide </span> </a> <label class="md-nav__link " for=__nav_5 id=__nav_5_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=true> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> User Guide </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../grids/ class=md-nav__link> <span class=md-ellipsis> Grids </span> </a> </li> <li class=md-nav__item> <a href=../../rock-properties/ class=md-nav__link> <span class=md-ellipsis> Rock Properties </span> </a> </li> <li class=md-nav__item> <a href=../../fluid-properties/ class=md-nav__link> <span class=md-ellipsis> Fluid Properties </span> </a> </li> <li class=md-nav__item> <a href=../../relative-permeability/ class=md-nav__link> <span class=md-ellipsis> Relative Permeability </span> </a> </li> <li class=md-nav__item> <a href=../../capillary-pressure/ class=md-nav__link> <span class=md-ellipsis> Capillary Pressure </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5_7> <label class=md-nav__link for=__nav_5_7 id=__nav_5_7_label tabindex> <span class=md-ellipsis> Wells </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_7_label aria-expanded=false> <label class=md-nav__title for=__nav_5_7> <span class="md-nav__icon md-icon"></span> Wells </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../wells/basics/ class=md-nav__link> <span class=md-ellipsis> Well Basics </span> </a> </li> <li class=md-nav__item> <a href=../../wells/controls/ class=md-nav__link> <span class=md-ellipsis> Well Controls </span> </a> </li> <li class=md-nav__item> <a href=../../wells/fluids/ class=md-nav__link> <span class=md-ellipsis> Well Fluids </span> </a> </li> <li class=md-nav__item> <a href=../../wells/schedules/ class=md-nav__link> <span class=md-ellipsis> Well Schedules </span> </a> </li> <li class=md-nav__item> <a href=../../wells/patterns/ class=md-nav__link> <span class=md-ellipsis> Well Patterns </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5_8> <label class=md-nav__link for=__nav_5_8 id=__nav_5_8_label tabindex> <span class=md-ellipsis> Simulation </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_8_label aria-expanded=false> <label class=md-nav__title for=__nav_5_8> <span class="md-nav__icon md-icon"></span> Simulation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../simulation/schemes/ class=md-nav__link> <span class=md-ellipsis> Schemes </span> </a> </li> <li class=md-nav__item> <a href=../../simulation/solvers/ class=md-nav__link> <span class=md-ellipsis> Solvers </span> </a> </li> <li class=md-nav__item> <a href=../../simulation/preconditioners/ class=md-nav__link> <span class=md-ellipsis> Preconditioners </span> </a> </li> <li class=md-nav__item> <a href=../../simulation/timestep-control/ class=md-nav__link> <span class=md-ellipsis> Timestep Control </span> </a> </li> <li class=md-nav__item> <a href=../../simulation/precision/ class=md-nav__link> <span class=md-ellipsis> Precision </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_9 checked> <label class=md-nav__link for=__nav_5_9 id=__nav_5_9_label tabindex> <span class=md-ellipsis> Advanced </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_9_label aria-expanded=true> <label class=md-nav__title for=__nav_5_9> <span class="md-nav__icon md-icon"></span> Advanced </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../pvt-tables/ class=md-nav__link> <span class=md-ellipsis> PVT Tables </span> </a> </li> <li class=md-nav__item> <a href=../fractures/ class=md-nav__link> <span class=md-ellipsis> Faults & Fractures </span> </a> </li> <li class=md-nav__item> <a href=../miscibility/ class=md-nav__link> <span class=md-ellipsis> Miscible Flooding </span> </a> </li> <li class=md-nav__item> <a href=../boundary-conditions/ class=md-nav__link> <span class=md-ellipsis> Boundary Conditions </span> </a> </li> <li class=md-nav__item> <a href=../aquifers/ class=md-nav__link> <span class=md-ellipsis> Aquifer Modeling </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> States & Streams </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> States & Streams </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#overview class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=#model-state class=md-nav__link> <span class=md-ellipsis> Model State </span> </a> <nav class=md-nav aria-label="Model State"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#accessing-reservoir-properties class=md-nav__link> <span class=md-ellipsis> Accessing Reservoir Properties </span> </a> </li> <li class=md-nav__item> <a href=#accessing-flow-properties class=md-nav__link> <span class=md-ellipsis> Accessing Flow Properties </span> </a> </li> <li class=md-nav__item> <a href=#well-information class=md-nav__link> <span class=md-ellipsis> Well Information </span> </a> </li> <li class=md-nav__item> <a href=#timer-state class=md-nav__link> <span class=md-ellipsis> Timer State </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#collecting-states class=md-nav__link> <span class=md-ellipsis> Collecting States </span> </a> <nav class=md-nav aria-label="Collecting States"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#output-frequency class=md-nav__link> <span class=md-ellipsis> Output Frequency </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#state-stream class=md-nav__link> <span class=md-ellipsis> State Stream </span> </a> <nav class=md-nav aria-label="State Stream"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#configuration-options class=md-nav__link> <span class=md-ellipsis> Configuration Options </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#stream-methods class=md-nav__link> <span class=md-ellipsis> Stream Methods </span> </a> <nav class=md-nav aria-label="Stream Methods"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#iterating-with-for class=md-nav__link> <span class=md-ellipsis> Iterating with for </span> </a> </li> <li class=md-nav__item> <a href=#consume class=md-nav__link> <span class=md-ellipsis> consume() </span> </a> </li> <li class=md-nav__item> <a href=#last class=md-nav__link> <span class=md-ellipsis> last() </span> </a> </li> <li class=md-nav__item> <a href=#untilcondition class=md-nav__link> <span class=md-ellipsis> until(condition) </span> </a> </li> <li class=md-nav__item> <a href=#while_condition class=md-nav__link> <span class=md-ellipsis> while_(condition) </span> </a> </li> <li class=md-nav__item> <a href=#replayindices-predicate-steps-validator class=md-nav__link> <span class=md-ellipsis> replay(indices, predicate, steps, validator) </span> </a> </li> <li class=md-nav__item> <a href=#flushblock class=md-nav__link> <span class=md-ellipsis> flush(block) </span> </a> </li> <li class=md-nav__item> <a href=#progress class=md-nav__link> <span class=md-ellipsis> progress() </span> </a> </li> <li class=md-nav__item> <a href=#properties class=md-nav__link> <span class=md-ellipsis> Properties </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#background-io class=md-nav__link> <span class=md-ellipsis> Background I/O </span> </a> </li> <li class=md-nav__item> <a href=#selective-saving class=md-nav__link> <span class=md-ellipsis> Selective Saving </span> </a> </li> <li class=md-nav__item> <a href=#checkpointing class=md-nav__link> <span class=md-ellipsis> Checkpointing </span> </a> <nav class=md-nav aria-label=Checkpointing> <ul class=md-nav__list> <li class=md-nav__item> <a href=#accessing-checkpoints class=md-nav__link> <span class=md-ellipsis> Accessing Checkpoints </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#idiomatic-patterns class=md-nav__link> <span class=md-ellipsis> Idiomatic Patterns </span> </a> <nav class=md-nav aria-label="Idiomatic Patterns"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#run-save-and-analyze class=md-nav__link> <span class=md-ellipsis> Run, Save, and Analyze </span> </a> </li> <li class=md-nav__item> <a href=#monitor-during-simulation class=md-nav__link> <span class=md-ellipsis> Monitor During Simulation </span> </a> </li> <li class=md-nav__item> <a href=#early-stopping class=md-nav__link> <span class=md-ellipsis> Early Stopping </span> </a> </li> <li class=md-nav__item> <a href=#sparse-replay class=md-nav__link> <span class=md-ellipsis> Sparse Replay </span> </a> </li> <li class=md-nav__item> <a href=#get-just-the-final-state class=md-nav__link> <span class=md-ellipsis> Get Just the Final State </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../model-analysis/ class=md-nav__link> <span class=md-ellipsis> Model Analysis </span> </a> </li> <li class=md-nav__item> <a href=../serialization/ class=md-nav__link> <span class=md-ellipsis> Serialization </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../config/ class=md-nav__link> <span class=md-ellipsis> Configuration </span> </a> </li> <li class=md-nav__item> <a href=../../constants/ class=md-nav__link> <span class=md-ellipsis> Constants </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6> <div class="md-nav__link md-nav__container"> <a href=../../../visualization/ class="md-nav__link "> <span class=md-ellipsis> Visualization </span> </a> <label class="md-nav__link " for=__nav_6 id=__nav_6_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Visualization </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../visualization/1d-plots/ class=md-nav__link> <span class=md-ellipsis> 1D Time Series </span> </a> </li> <li class=md-nav__item> <a href=../../../visualization/2d-maps/ class=md-nav__link> <span class=md-ellipsis> 2D Maps </span> </a> </li> <li class=md-nav__item> <a href=../../../visualization/3d-rendering/ class=md-nav__link> <span class=md-ellipsis> 3D Volume Rendering </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_7> <div class="md-nav__link md-nav__container"> <a href=../../../api-reference/ class="md-nav__link "> <span class=md-ellipsis> API Reference </span> </a> <label class="md-nav__link " for=__nav_7 id=__nav_7_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> API Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../api-reference/correlations-scalar/ class=md-nav__link> <span class=md-ellipsis> Scalar Correlations </span> </a> </li> <li class=md-nav__item> <a href=../../../api-reference/correlations-array/ class=md-nav__link> <span class=md-ellipsis> Array Correlations </span> </a> </li> <li class=md-nav__item> <a href=../../../api-reference/full-api/ class=md-nav__link> <span class=md-ellipsis> Full API </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_8> <div class="md-nav__link md-nav__container"> <a href=../../../best-practices/ class="md-nav__link "> <span class=md-ellipsis> Best Practices </span> </a> <label class="md-nav__link " for=__nav_8 id=__nav_8_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_8_label aria-expanded=false> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> Best Practices </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../best-practices/grid-design/ class=md-nav__link> <span class=md-ellipsis> Grid Design </span> </a> </li> <li class=md-nav__item> <a href=../../../best-practices/timestep-selection/ class=md-nav__link> <span class=md-ellipsis> Timestep Selection </span> </a> </li> <li class=md-nav__item> <a href=../../../best-practices/solver-selection/ class=md-nav__link> <span class=md-ellipsis> Solver Selection </span> </a> </li> <li class=md-nav__item> <a href=../../../best-practices/errors/ class=md-nav__link> <span class=md-ellipsis> Errors </span> </a> </li> <li class=md-nav__item> <a href=../../../best-practices/performance/ class=md-nav__link> <span class=md-ellipsis> Performance </span> </a> </li> <li class=md-nav__item> <a href=../../../best-practices/validation/ class=md-nav__link> <span class=md-ellipsis> Validation </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_9> <div class="md-nav__link md-nav__container"> <a href=../../../examples/ class="md-nav__link "> <span class=md-ellipsis> Examples </span> </a> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_9_label aria-expanded=false> <label class=md-nav__title for=__nav_9> <span class="md-nav__icon md-icon"></span> Examples </label> <ul class=md-nav__list data-md-scrollfix> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_10> <label class=md-nav__link for=__nav_10 id=__nav_10_label tabindex=0> <span class=md-ellipsis> Reference </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_10_label aria-expanded=false> <label class=md-nav__title for=__nav_10> <span class="md-nav__icon md-icon"></span> Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../reference/glossary/ class=md-nav__link> <span class=md-ellipsis> Glossary </span> </a> </li> <li class=md-nav__item> <a href=../../../reference/units/ class=md-nav__link> <span class=md-ellipsis> Units </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#overview class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=#model-state class=md-nav__link> <span class=md-ellipsis> Model State </span> </a> <nav class=md-nav aria-label="Model State"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#accessing-reservoir-properties class=md-nav__link> <span class=md-ellipsis> Accessing Reservoir Properties </span> </a> </li> <li class=md-nav__item> <a href=#accessing-flow-properties class=md-nav__link> <span class=md-ellipsis> Accessing Flow Properties </span> </a> </li> <li class=md-nav__item> <a href=#well-information class=md-nav__link> <span class=md-ellipsis> Well Information </span> </a> </li> <li class=md-nav__item> <a href=#timer-state class=md-nav__link> <span class=md-ellipsis> Timer State </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#collecting-states class=md-nav__link> <span class=md-ellipsis> Collecting States </span> </a> <nav class=md-nav aria-label="Collecting States"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#output-frequency class=md-nav__link> <span class=md-ellipsis> Output Frequency </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#state-stream class=md-nav__link> <span class=md-ellipsis> State Stream </span> </a> <nav class=md-nav aria-label="State Stream"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#configuration-options class=md-nav__link> <span class=md-ellipsis> Configuration Options </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#stream-methods class=md-nav__link> <span class=md-ellipsis> Stream Methods </span> </a> <nav class=md-nav aria-label="Stream Methods"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#iterating-with-for class=md-nav__link> <span class=md-ellipsis> Iterating with for </span> </a> </li> <li class=md-nav__item> <a href=#consume class=md-nav__link> <span class=md-ellipsis> consume() </span> </a> </li> <li class=md-nav__item> <a href=#last class=md-nav__link> <span class=md-ellipsis> last() </span> </a> </li> <li class=md-nav__item> <a href=#untilcondition class=md-nav__link> <span class=md-ellipsis> until(condition) </span> </a> </li> <li class=md-nav__item> <a href=#while_condition class=md-nav__link> <span class=md-ellipsis> while_(condition) </span> </a> </li> <li class=md-nav__item> <a href=#replayindices-predicate-steps-validator class=md-nav__link> <span class=md-ellipsis> replay(indices, predicate, steps, validator) </span> </a> </li> <li class=md-nav__item> <a href=#flushblock class=md-nav__link> <span class=md-ellipsis> flush(block) </span> </a> </li> <li class=md-nav__item> <a href=#progress class=md-nav__link> <span class=md-ellipsis> progress() </span> </a> </li> <li class=md-nav__item> <a href=#properties class=md-nav__link> <span class=md-ellipsis> Properties </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#background-io class=md-nav__link> <span class=md-ellipsis> Background I/O </span> </a> </li> <li class=md-nav__item> <a href=#selective-saving class=md-nav__link> <span class=md-ellipsis> Selective Saving </span> </a> </li> <li class=md-nav__item> <a href=#checkpointing class=md-nav__link> <span class=md-ellipsis> Checkpointing </span> </a> <nav class=md-nav aria-label=Checkpointing> <ul class=md-nav__list> <li class=md-nav__item> <a href=#accessing-checkpoints class=md-nav__link> <span class=md-ellipsis> Accessing Checkpoints </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#idiomatic-patterns class=md-nav__link> <span class=md-ellipsis> Idiomatic Patterns </span> </a> <nav class=md-nav aria-label="Idiomatic Patterns"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#run-save-and-analyze class=md-nav__link> <span class=md-ellipsis> Run, Save, and Analyze </span> </a> </li> <li class=md-nav__item> <a href=#monitor-during-simulation class=md-nav__link> <span class=md-ellipsis> Monitor During Simulation </span> </a> </li> <li class=md-nav__item> <a href=#early-stopping class=md-nav__link> <span class=md-ellipsis> Early Stopping </span> </a> </li> <li class=md-nav__item> <a href=#sparse-replay class=md-nav__link> <span class=md-ellipsis> Sparse Replay </span> </a> </li> <li class=md-nav__item> <a href=#get-just-the-final-state class=md-nav__link> <span class=md-ellipsis> Get Just the Final State </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <nav class=md-path aria-label=Navigation> <ol class=md-path__list> <li class=md-path__item> <a href=../../.. class=md-path__link> <span class=md-ellipsis> Home </span> </a> </li> <li class=md-path__item> <a href=../../ class=md-path__link> <span class=md-ellipsis> User Guide </span> </a> </li> <li class=md-path__item> <a href=../pvt-tables/ class=md-path__link> <span class=md-ellipsis> Advanced </span> </a> </li> </ol> </nav> <article class="md-content__inner md-typeset"> <a href=https://github.com/ti-oluwa/bores/edit/main/docs/user-guide/advanced/states-streams.md title="Edit this page" class="md-content__button md-icon" rel=edit> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75z"/></svg> </a> <a href=https://github.com/ti-oluwa/bores/raw/main/docs/user-guide/advanced/states-streams.md title="View source of this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5 5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5"/></svg> </a> <h1 id=states-and-streams>States and Streams<a class=headerlink href=#states-and-streams title="Permanent link">&para;</a></h1> <h2 id=overview>Overview<a class=headerlink href=#overview title="Permanent link">&para;</a></h2> <p>When you run a BORES simulation, the simulator produces a sequence of <code>ModelState</code> objects, one for each accepted time step. Each state captures a complete snapshot of the reservoir at that moment: pressures, saturations, well rates, relative permeabilities, mobilities, and capillary pressures. Understanding how to work with states is essential for analyzing simulation results.</p> <p>For large simulations, holding all states in memory simultaneously can be expensive. A 100,000-cell model with 500 time steps generates roughly 2 GB of state data at 32-bit precision. The <code>StateStream</code> class solves this by persisting states to disk as they are produced and optionally replaying them later, keeping memory usage constant regardless of simulation length.</p> <p>Beyond just collecting and storing states, BORES provides <code>ModelAnalyst</code> for post-processing simulation results. The analyst accepts states (from a list, a stream, or a store replay) and computes volumetrics, recovery factors, production histories, material balance drive indices, sweep efficiency, decline curves, and well productivity metrics. See the <a href=../model-analysis/ >Model Analysis</a> page for full details on the analyst API.</p> <hr> <h2 id=model-state>Model State<a class=headerlink href=#model-state title="Permanent link">&para;</a></h2> <p>The <code>ModelState</code> class is a frozen (immutable) attrs class that captures the reservoir state at a single time step. Every field on a <code>ModelState</code> is a snapshot in time. Because the class is frozen, you cannot mutate any field after creation. If you need a modified version, use <code>attrs.evolve()</code> to create a copy with selected fields changed.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=n>states</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>bores</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>config</span><span class=p>))</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=n>state</span> <span class=o>=</span> <span class=n>states</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>  <span class=c1># Last time step</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=c1># Time information</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=nb>print</span><span class=p>(</span><span class=n>state</span><span class=o>.</span><span class=n>step</span><span class=p>)</span>              <span class=c1># Time step index (0-based)</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=nb>print</span><span class=p>(</span><span class=n>state</span><span class=o>.</span><span class=n>step_size</span><span class=p>)</span>         <span class=c1># Step size in seconds</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=nb>print</span><span class=p>(</span><span class=n>state</span><span class=o>.</span><span class=n>time</span><span class=p>)</span>              <span class=c1># Elapsed time in seconds</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=nb>print</span><span class=p>(</span><span class=n>state</span><span class=o>.</span><span class=n>time_in_days</span><span class=p>)</span>      <span class=c1># Elapsed time in days</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=nb>print</span><span class=p>(</span><span class=n>state</span><span class=o>.</span><span class=n>time_in_years</span><span class=p>)</span>     <span class=c1># Elapsed time in years</span>
</span></code></pre></div> <h3 id=accessing-reservoir-properties>Accessing Reservoir Properties<a class=headerlink href=#accessing-reservoir-properties title="Permanent link">&para;</a></h3> <p>The <code>model</code> field contains the full reservoir model with all property grids. The model itself is also frozen, so you always get a consistent snapshot of the reservoir at that moment.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=c1># Pressure and saturation grids (3D numpy arrays matching grid shape)</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=n>pressure</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>fluid_properties</span><span class=o>.</span><span class=n>pressure_grid</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=n>Sw</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>fluid_properties</span><span class=o>.</span><span class=n>water_saturation_grid</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=n>So</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>fluid_properties</span><span class=o>.</span><span class=n>oil_saturation_grid</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=n>Sg</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>fluid_properties</span><span class=o>.</span><span class=n>gas_saturation_grid</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=c1># PVT properties</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=n>oil_visc</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>fluid_properties</span><span class=o>.</span><span class=n>oil_viscosity_grid</span>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=n>water_visc</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>fluid_properties</span><span class=o>.</span><span class=n>water_viscosity_grid</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a><span class=n>oil_fvf</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>fluid_properties</span><span class=o>.</span><span class=n>oil_formation_volume_factor_grid</span>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a><span class=n>gas_fvf</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>fluid_properties</span><span class=o>.</span><span class=n>gas_formation_volume_factor_grid</span>
</span><span id=__span-1-12><a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a><span class=n>Rs</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>fluid_properties</span><span class=o>.</span><span class=n>solution_gas_to_oil_ratio_grid</span>
</span><span id=__span-1-13><a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a><span class=n>Pb</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>fluid_properties</span><span class=o>.</span><span class=n>oil_bubble_point_pressure_grid</span>
</span><span id=__span-1-14><a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a>
</span><span id=__span-1-15><a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a><span class=c1># Rock properties</span>
</span><span id=__span-1-16><a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a><span class=n>porosity</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>rock_properties</span><span class=o>.</span><span class=n>porosity_grid</span>
</span><span id=__span-1-17><a id=__codelineno-1-17 name=__codelineno-1-17 href=#__codelineno-1-17></a><span class=n>perm_x</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>rock_properties</span><span class=o>.</span><span class=n>absolute_permeability</span><span class=o>.</span><span class=n>x</span>
</span><span id=__span-1-18><a id=__codelineno-1-18 name=__codelineno-1-18 href=#__codelineno-1-18></a><span class=n>perm_y</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>rock_properties</span><span class=o>.</span><span class=n>absolute_permeability</span><span class=o>.</span><span class=n>y</span>
</span><span id=__span-1-19><a id=__codelineno-1-19 name=__codelineno-1-19 href=#__codelineno-1-19></a><span class=n>perm_z</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>rock_properties</span><span class=o>.</span><span class=n>absolute_permeability</span><span class=o>.</span><span class=n>z</span>
</span></code></pre></div> <h3 id=accessing-flow-properties>Accessing Flow Properties<a class=headerlink href=#accessing-flow-properties title="Permanent link">&para;</a></h3> <p>Injection and production rates, relative permeabilities, and mobilities are stored directly on the state rather than nested inside the model. Rates are in reservoir cubic feet per day at the cell level.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=c1># Injection and production rates (ft3/day per cell)</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=n>oil_injection</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>injection</span><span class=o>.</span><span class=n>oil</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=n>water_injection</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>injection</span><span class=o>.</span><span class=n>water</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=n>gas_injection</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>injection</span><span class=o>.</span><span class=n>gas</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=n>oil_production</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>production</span><span class=o>.</span><span class=n>oil</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=n>water_production</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>production</span><span class=o>.</span><span class=n>water</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=n>gas_production</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>production</span><span class=o>.</span><span class=n>gas</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=c1># Relative permeabilities (dimensionless, 0 to 1)</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=n>kro</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>relative_permeabilities</span><span class=o>.</span><span class=n>oil</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a><span class=n>krw</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>relative_permeabilities</span><span class=o>.</span><span class=n>water</span>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=n>krg</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>relative_permeabilities</span><span class=o>.</span><span class=n>gas</span>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a><span class=c1># Relative mobilities (1/cP, kr/mu)</span>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a><span class=n>lambda_o</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>relative_mobilities</span><span class=o>.</span><span class=n>oil</span>
</span><span id=__span-2-17><a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a><span class=n>lambda_w</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>relative_mobilities</span><span class=o>.</span><span class=n>water</span>
</span><span id=__span-2-18><a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a><span class=n>lambda_g</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>relative_mobilities</span><span class=o>.</span><span class=n>gas</span>
</span><span id=__span-2-19><a id=__codelineno-2-19 name=__codelineno-2-19 href=#__codelineno-2-19></a>
</span><span id=__span-2-20><a id=__codelineno-2-20 name=__codelineno-2-20 href=#__codelineno-2-20></a><span class=c1># Capillary pressures (psi)</span>
</span><span id=__span-2-21><a id=__codelineno-2-21 name=__codelineno-2-21 href=#__codelineno-2-21></a><span class=n>pcow</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>capillary_pressures</span><span class=o>.</span><span class=n>oil_water</span>
</span><span id=__span-2-22><a id=__codelineno-2-22 name=__codelineno-2-22 href=#__codelineno-2-22></a><span class=n>pcog</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>capillary_pressures</span><span class=o>.</span><span class=n>oil_gas</span>
</span></code></pre></div> <h3 id=well-information>Well Information<a class=headerlink href=#well-information title="Permanent link">&para;</a></h3> <p>The well configuration at each state is accessible through the <code>wells</code> field. The <code>wells_exists()</code> method checks whether any wells are defined without loading the full well data structure.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=k>if</span> <span class=n>state</span><span class=o>.</span><span class=n>wells_exists</span><span class=p>():</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>    <span class=n>wells</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>wells</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>    <span class=k>for</span> <span class=n>well</span> <span class=ow>in</span> <span class=n>wells</span><span class=o>.</span><span class=n>production_wells</span><span class=p>:</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Well </span><span class=si>{</span><span class=n>well</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>: skin=</span><span class=si>{</span><span class=n>well</span><span class=o>.</span><span class=n>skin_factor</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span></code></pre></div> <h3 id=timer-state>Timer State<a class=headerlink href=#timer-state title="Permanent link">&para;</a></h3> <p>The timer's internal state (step count, proposed next step size, performance history) is optionally captured when <code>Config.capture_timer_state</code> is enabled.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=k>if</span> <span class=n>state</span><span class=o>.</span><span class=n>timer_state</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>    <span class=n>ts</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>timer_state</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Next proposed step: </span><span class=si>{</span><span class=n>ts</span><span class=p>[</span><span class=s1>&#39;next_step_size&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> seconds&quot;</span><span class=p>)</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Steps since failure: </span><span class=si>{</span><span class=n>ts</span><span class=p>[</span><span class=s1>&#39;steps_since_last_failure&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span></code></pre></div> <hr> <h2 id=collecting-states>Collecting States<a class=headerlink href=#collecting-states title="Permanent link">&para;</a></h2> <p>The simplest approach is to collect all states in a list. The <code>bores.run()</code> function returns a generator, so calling <code>list()</code> forces the entire simulation to run and stores every state in memory.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=n>states</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>bores</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>config</span><span class=p>))</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=c1># Extract time series data</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=n>time_days</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>s</span><span class=o>.</span><span class=n>time_in_days</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>states</span><span class=p>])</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=n>avg_pressure</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a>    <span class=n>s</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>fluid_properties</span><span class=o>.</span><span class=n>pressure_grid</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>states</span>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=p>])</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a><span class=n>avg_So</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a>    <span class=n>s</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>fluid_properties</span><span class=o>.</span><span class=n>oil_saturation_grid</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>states</span>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a><span class=p>])</span>
</span></code></pre></div> <p>This is fine for simulations that produce a manageable number of states (up to a few hundred). For longer runs, consider using <code>output_frequency</code> in the <code>Config</code> to reduce the number of states, or use <code>StateStream</code> for disk-backed persistence.</p> <h3 id=output-frequency>Output Frequency<a class=headerlink href=#output-frequency title="Permanent link">&para;</a></h3> <p>The <code>output_frequency</code> parameter in <code>Config</code> controls how often states are yielded:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=n>config</span> <span class=o>=</span> <span class=n>bores</span><span class=o>.</span><span class=n>Config</span><span class=p>(</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>    <span class=n>timer</span><span class=o>=</span><span class=n>timer</span><span class=p>,</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>    <span class=n>rock_fluid_tables</span><span class=o>=</span><span class=n>rock_fluid</span><span class=p>,</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>    <span class=n>wells</span><span class=o>=</span><span class=n>wells</span><span class=p>,</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>    <span class=n>output_frequency</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span>  <span class=c1># Yield every 10th step</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=p>)</span>
</span></code></pre></div> <p>With <code>output_frequency=10</code>, the simulator still runs all time steps internally but only yields a state every 10<sup>th</sup> step, reducing memory usage by 10x. The intermediate steps are computed but not stored.</p> <hr> <h2 id=state-stream>State Stream<a class=headerlink href=#state-stream title="Permanent link">&para;</a></h2> <p><code>StateStream</code> provides memory-efficient state iteration with optional disk persistence. It wraps the simulation generator and writes states to a <code>DataStore</code> as they are produced, immediately freeing the memory used by each state. The stream acts as both a context manager and an iterator, and offers several methods for controlling how you consume and replay states.</p> <p>The core idea is that you iterate through states exactly once during the simulation. As each state passes through, the stream optionally persists it to a store. After the simulation is exhausted, you can replay any or all of the saved states from the store without re-running the simulation. This keeps peak memory usage proportional to <code>batch_size</code> rather than the total number of states.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=kn>from</span><span class=w> </span><span class=nn>bores.streams</span><span class=w> </span><span class=kn>import</span> <span class=n>StateStream</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=kn>from</span><span class=w> </span><span class=nn>bores.stores</span><span class=w> </span><span class=kn>import</span> <span class=n>ZarrStore</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=n>store</span> <span class=o>=</span> <span class=n>ZarrStore</span><span class=p>(</span><span class=s2>&quot;simulation_run.zarr&quot;</span><span class=p>)</span>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a><span class=k>with</span> <span class=n>StateStream</span><span class=p>(</span>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a>    <span class=n>states</span><span class=o>=</span><span class=n>bores</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>config</span><span class=p>),</span>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a>    <span class=n>store</span><span class=o>=</span><span class=n>store</span><span class=p>,</span>
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a>    <span class=n>batch_size</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span>
</span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a><span class=p>)</span> <span class=k>as</span> <span class=n>stream</span><span class=p>:</span>
</span><span id=__span-7-11><a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a>    <span class=k>for</span> <span class=n>state</span> <span class=ow>in</span> <span class=n>stream</span><span class=p>:</span>
</span><span id=__span-7-12><a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Step </span><span class=si>{</span><span class=n>state</span><span class=o>.</span><span class=n>step</span><span class=si>}</span><span class=s2>: P_avg = </span><span class=si>{</span><span class=n>state</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>fluid_properties</span><span class=o>.</span><span class=n>pressure_grid</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span></code></pre></div> <h3 id=configuration-options>Configuration Options<a class=headerlink href=#configuration-options title="Permanent link">&para;</a></h3> <table> <thead> <tr> <th>Parameter</th> <th>Default</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>states</code></td> <td>(required)</td> <td>Generator or iterator of <code>ModelState</code> instances</td> </tr> <tr> <td><code>store</code></td> <td><code>None</code></td> <td>Storage backend for persistence. Must support appending</td> </tr> <tr> <td><code>batch_size</code></td> <td>10</td> <td>States accumulated before flushing to disk</td> </tr> <tr> <td><code>validate</code></td> <td><code>False</code></td> <td>Validate states before saving (checks grid shapes, dtype consistency)</td> </tr> <tr> <td><code>auto_save</code></td> <td><code>True</code></td> <td>Flush remaining states on context exit</td> </tr> <tr> <td><code>auto_replay</code></td> <td><code>True</code></td> <td>Replay from store when iterating after consumption</td> </tr> <tr> <td><code>save</code></td> <td><code>True</code></td> <td>Boolean or filter function for selective saving</td> </tr> <tr> <td><code>background_io</code></td> <td><code>False</code></td> <td>Write to disk in a background thread</td> </tr> <tr> <td><code>max_queue_size</code></td> <td>50</td> <td>Back-pressure limit for background I/O queue</td> </tr> <tr> <td><code>checkpoint_interval</code></td> <td><code>None</code></td> <td>Create a checkpoint every N states</td> </tr> <tr> <td><code>checkpoint_store</code></td> <td><code>None</code></td> <td>Separate store for checkpoints</td> </tr> <tr> <td><code>max_batch_memory_usage</code></td> <td><code>None</code></td> <td>Force flush when batch exceeds this size (MB)</td> </tr> </tbody> </table> <hr> <h2 id=stream-methods>Stream Methods<a class=headerlink href=#stream-methods title="Permanent link">&para;</a></h2> <h3 id=iterating-with-for>Iterating with <code>for</code><a class=headerlink href=#iterating-with-for title="Permanent link">&para;</a></h3> <p>The most common way to use a stream is the <code>for</code> loop. On the first pass, the stream consumes the underlying generator, yielding each state and persisting it to the store according to the <code>save</code> and <code>batch_size</code> settings. If you iterate again after the generator is exhausted, the stream automatically replays from the store (if <code>auto_replay=True</code>).</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=k>with</span> <span class=n>StateStream</span><span class=p>(</span><span class=n>states</span><span class=o>=</span><span class=n>bores</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>config</span><span class=p>),</span> <span class=n>store</span><span class=o>=</span><span class=n>store</span><span class=p>)</span> <span class=k>as</span> <span class=n>stream</span><span class=p>:</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a>    <span class=c1># First pass: runs the simulation, saves states</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a>    <span class=k>for</span> <span class=n>state</span> <span class=ow>in</span> <span class=n>stream</span><span class=p>:</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a>        <span class=n>process</span><span class=p>(</span><span class=n>state</span><span class=p>)</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>    <span class=c1># Second pass: replays from store (no re-simulation)</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a>    <span class=k>for</span> <span class=n>state</span> <span class=ow>in</span> <span class=n>stream</span><span class=p>:</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a>        <span class=n>plot</span><span class=p>(</span><span class=n>state</span><span class=p>)</span>
</span></code></pre></div> <p>If <code>auto_replay</code> is <code>False</code>, iterating a second time raises a <code>StreamError</code>. In that case, you must call <code>replay()</code> explicitly.</p> <h3 id=consume>consume()<a class=headerlink href=#consume title="Permanent link">&para;</a></h3> <p>The <code>consume()</code> method exhausts the entire stream without yielding any states to your code. All configured side effects (persistence, checkpointing, validation) still occur normally. This is useful when you want to run a simulation purely for the purpose of saving its output to disk.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=n>stream</span> <span class=o>=</span> <span class=n>StateStream</span><span class=p>(</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a>    <span class=n>states</span><span class=o>=</span><span class=n>bores</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>config</span><span class=p>),</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a>    <span class=n>store</span><span class=o>=</span><span class=n>ZarrStore</span><span class=p>(</span><span class=s2>&quot;run.zarr&quot;</span><span class=p>),</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a>    <span class=n>checkpoint_store</span><span class=o>=</span><span class=n>ZarrStore</span><span class=p>(</span><span class=s2>&quot;checkpoints.zarr&quot;</span><span class=p>),</span>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a>    <span class=n>checkpoint_interval</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span>
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a><span class=p>)</span>
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a><span class=n>stream</span><span class=o>.</span><span class=n>consume</span><span class=p>()</span>  <span class=c1># States saved and checkpointed, nothing returned</span>
</span></code></pre></div> <p>After calling <code>consume()</code>, the stream is marked as consumed. Calling <code>consume()</code> again has no effect. You can still call <code>replay()</code> to load the saved states.</p> <h3 id=last>last()<a class=headerlink href=#last title="Permanent link">&para;</a></h3> <p>The <code>last()</code> method returns the final state from the stream. If the stream has not been consumed yet, it iterates through the entire simulation (triggering all side effects) and returns the last state yielded. If the stream has already been consumed and a store is available, it loads only the last entry from the store without replaying everything.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=k>with</span> <span class=n>StateStream</span><span class=p>(</span><span class=n>states</span><span class=o>=</span><span class=n>bores</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>config</span><span class=p>),</span> <span class=n>store</span><span class=o>=</span><span class=n>store</span><span class=p>)</span> <span class=k>as</span> <span class=n>stream</span><span class=p>:</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a>    <span class=n>final_state</span> <span class=o>=</span> <span class=n>stream</span><span class=o>.</span><span class=n>last</span><span class=p>()</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Final pressure: </span><span class=si>{</span><span class=n>final_state</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>fluid_properties</span><span class=o>.</span><span class=n>pressure_grid</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span></code></pre></div> <p>This is particularly useful when you only need the end result of a simulation but still want all intermediate states saved to disk.</p> <h3 id=untilcondition>until(condition)<a class=headerlink href=#untilcondition title="Permanent link">&para;</a></h3> <p>The <code>until()</code> method iterates through the stream, yielding states one at a time, until the <code>condition</code> function returns <code>True</code>. The state that satisfies the condition is yielded as well, then iteration stops. All configured side effects (persistence, checkpointing) apply to every state that passes through, including those before the stop condition is met.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=k>with</span> <span class=n>StateStream</span><span class=p>(</span><span class=n>states</span><span class=o>=</span><span class=n>bores</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>config</span><span class=p>),</span> <span class=n>store</span><span class=o>=</span><span class=n>store</span><span class=p>)</span> <span class=k>as</span> <span class=n>stream</span><span class=p>:</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a>    <span class=c1># Run until average pressure drops below 1500 psi</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a>    <span class=k>for</span> <span class=n>state</span> <span class=ow>in</span> <span class=n>stream</span><span class=o>.</span><span class=n>until</span><span class=p>(</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a>        <span class=k>lambda</span> <span class=n>s</span><span class=p>:</span> <span class=n>s</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>fluid_properties</span><span class=o>.</span><span class=n>pressure_grid</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>&lt;</span> <span class=mf>1500.0</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a>    <span class=p>):</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Step </span><span class=si>{</span><span class=n>state</span><span class=o>.</span><span class=n>step</span><span class=si>}</span><span class=s2>: P = </span><span class=si>{</span><span class=n>state</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>fluid_properties</span><span class=o>.</span><span class=n>pressure_grid</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span></code></pre></div> <p>The condition receives a <code>ModelState</code> and returns a boolean. Use <code>until()</code> when you have a physical stopping criterion ("stop when water cut exceeds 95%") rather than a fixed number of steps. Note that the remaining states in the underlying generator are not consumed, so the simulation stops early. If the condition never becomes <code>True</code>, the entire stream is consumed.</p> <h3 id=while_condition>while_(condition)<a class=headerlink href=#while_condition title="Permanent link">&para;</a></h3> <p>The <code>while_()</code> method is the complement of <code>until()</code>. It iterates as long as the <code>condition</code> returns <code>True</code>, and stops when the condition becomes <code>False</code>. The final state (where the condition failed) is also yielded.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=k>with</span> <span class=n>StateStream</span><span class=p>(</span><span class=n>states</span><span class=o>=</span><span class=n>bores</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>config</span><span class=p>),</span> <span class=n>store</span><span class=o>=</span><span class=n>store</span><span class=p>)</span> <span class=k>as</span> <span class=n>stream</span><span class=p>:</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a>    <span class=c1># Run while oil saturation is above residual</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a>    <span class=k>for</span> <span class=n>state</span> <span class=ow>in</span> <span class=n>stream</span><span class=o>.</span><span class=n>while_</span><span class=p>(</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a>        <span class=k>lambda</span> <span class=n>s</span><span class=p>:</span> <span class=n>s</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>fluid_properties</span><span class=o>.</span><span class=n>oil_saturation_grid</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mf>0.15</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a>    <span class=p>):</span>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a>        <span class=n>analyze</span><span class=p>(</span><span class=n>state</span><span class=p>)</span>
</span></code></pre></div> <p>Like <code>until()</code>, all side effects apply to every state that passes through. The key difference is the semantics: <code>until()</code> runs until something happens, <code>while_()</code> runs while something holds. Choose whichever reads more naturally for your use case.</p> <h3 id=replayindices-predicate-steps-validator>replay(indices, predicate, steps, validator)<a class=headerlink href=#replayindices-predicate-steps-validator title="Permanent link">&para;</a></h3> <p>The <code>replay()</code> method loads previously saved states from the store. It returns an iterator, so you can process states one at a time without loading everything into memory. Filtering happens before deserialization, so skipped entries have no I/O cost.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=c1># Replay all saved states</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=k>for</span> <span class=n>state</span> <span class=ow>in</span> <span class=n>stream</span><span class=o>.</span><span class=n>replay</span><span class=p>():</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a>    <span class=n>plot</span><span class=p>(</span><span class=n>state</span><span class=p>)</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=c1># Replay specific entries by insertion-order index</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=k>for</span> <span class=n>state</span> <span class=ow>in</span> <span class=n>stream</span><span class=o>.</span><span class=n>replay</span><span class=p>(</span><span class=n>indices</span><span class=o>=</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>50</span><span class=p>,</span> <span class=mi>99</span><span class=p>]):</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a>    <span class=n>compare</span><span class=p>(</span><span class=n>state</span><span class=p>)</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a><span class=c1># Replay by simulation step number</span>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a><span class=k>for</span> <span class=n>state</span> <span class=ow>in</span> <span class=n>stream</span><span class=o>.</span><span class=n>replay</span><span class=p>(</span><span class=n>steps</span><span class=o>=</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>100</span><span class=p>,</span> <span class=mi>200</span><span class=p>,</span> <span class=mi>300</span><span class=p>]):</span>
</span><span id=__span-13-11><a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a>    <span class=n>analyze</span><span class=p>(</span><span class=n>state</span><span class=p>)</span>
</span><span id=__span-13-12><a id=__codelineno-13-12 name=__codelineno-13-12 href=#__codelineno-13-12></a>
</span><span id=__span-13-13><a id=__codelineno-13-13 name=__codelineno-13-13 href=#__codelineno-13-13></a><span class=c1># Replay using a step filter function</span>
</span><span id=__span-13-14><a id=__codelineno-13-14 name=__codelineno-13-14 href=#__codelineno-13-14></a><span class=k>for</span> <span class=n>state</span> <span class=ow>in</span> <span class=n>stream</span><span class=o>.</span><span class=n>replay</span><span class=p>(</span><span class=n>steps</span><span class=o>=</span><span class=k>lambda</span> <span class=n>s</span><span class=p>:</span> <span class=n>s</span> <span class=o>%</span> <span class=mi>50</span> <span class=o>==</span> <span class=mi>0</span><span class=p>):</span>
</span><span id=__span-13-15><a id=__codelineno-13-15 name=__codelineno-13-15 href=#__codelineno-13-15></a>    <span class=n>log</span><span class=p>(</span><span class=n>state</span><span class=p>)</span>
</span><span id=__span-13-16><a id=__codelineno-13-16 name=__codelineno-13-16 href=#__codelineno-13-16></a>
</span><span id=__span-13-17><a id=__codelineno-13-17 name=__codelineno-13-17 href=#__codelineno-13-17></a><span class=c1># Replay with metadata predicate</span>
</span><span id=__span-13-18><a id=__codelineno-13-18 name=__codelineno-13-18 href=#__codelineno-13-18></a><span class=k>for</span> <span class=n>state</span> <span class=ow>in</span> <span class=n>stream</span><span class=o>.</span><span class=n>replay</span><span class=p>(</span><span class=n>predicate</span><span class=o>=</span><span class=k>lambda</span> <span class=n>e</span><span class=p>:</span> <span class=n>e</span><span class=o>.</span><span class=n>meta</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;step&quot;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>100</span><span class=p>):</span>
</span><span id=__span-13-19><a id=__codelineno-13-19 name=__codelineno-13-19 href=#__codelineno-13-19></a>    <span class=n>late_analysis</span><span class=p>(</span><span class=n>state</span><span class=p>)</span>
</span></code></pre></div> <p>The parameters can be combined. <code>indices</code> takes priority and bypasses <code>steps</code> and <code>predicate</code>. When both <code>steps</code> and <code>predicate</code> are provided, they are composed with a logical AND (both must pass for a state to be yielded).</p> <table> <thead> <tr> <th>Parameter</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>indices</code></td> <td><code>Sequence[int]</code></td> <td>Zero-based insertion-order positions to load</td> </tr> <tr> <td><code>steps</code></td> <td><code>Sequence[int]</code> or <code>Callable[[int], bool]</code></td> <td>Filter by simulation step number</td> </tr> <tr> <td><code>predicate</code></td> <td><code>Callable[[EntryMeta], bool]</code></td> <td>Filter on stored entry metadata</td> </tr> <tr> <td><code>validator</code></td> <td><code>Callable[[ModelState], ModelState]</code></td> <td>Post-load validation/transformation</td> </tr> </tbody> </table> <h3 id=flushblock>flush(block)<a class=headerlink href=#flushblock title="Permanent link">&para;</a></h3> <p>The <code>flush()</code> method manually writes the current batch buffer to the store. In normal operation, flushing happens automatically when the batch reaches <code>batch_size</code> or when the stream exits its context manager. Call <code>flush()</code> explicitly when you need to guarantee that data has been written at a specific point.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=k>with</span> <span class=n>StateStream</span><span class=p>(</span><span class=n>states</span><span class=o>=</span><span class=n>bores</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>config</span><span class=p>),</span> <span class=n>store</span><span class=o>=</span><span class=n>store</span><span class=p>,</span> <span class=n>batch_size</span><span class=o>=</span><span class=mi>50</span><span class=p>)</span> <span class=k>as</span> <span class=n>stream</span><span class=p>:</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a>    <span class=k>for</span> <span class=n>state</span> <span class=ow>in</span> <span class=n>stream</span><span class=p>:</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a>        <span class=k>if</span> <span class=n>state</span><span class=o>.</span><span class=n>step</span> <span class=o>%</span> <span class=mi>100</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a>            <span class=n>stream</span><span class=o>.</span><span class=n>flush</span><span class=p>(</span><span class=n>block</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>  <span class=c1># Ensure data is on disk now</span>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Flushed through step </span><span class=si>{</span><span class=n>state</span><span class=o>.</span><span class=n>step</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span></code></pre></div> <p>The <code>block</code> parameter controls behavior when <code>background_io=True</code>. With <code>block=False</code> (the default), the batch is enqueued and the method returns immediately. With <code>block=True</code>, the method waits until all pending writes have completed.</p> <h3 id=progress>progress()<a class=headerlink href=#progress title="Permanent link">&para;</a></h3> <p>The <code>progress()</code> method returns a <code>StreamProgress</code> dictionary with real-time statistics about the stream's state. Use this for monitoring long-running simulations or building progress bars.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=k>with</span> <span class=n>StateStream</span><span class=p>(</span><span class=n>states</span><span class=o>=</span><span class=n>bores</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>config</span><span class=p>),</span> <span class=n>store</span><span class=o>=</span><span class=n>store</span><span class=p>)</span> <span class=k>as</span> <span class=n>stream</span><span class=p>:</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a>    <span class=k>for</span> <span class=n>state</span> <span class=ow>in</span> <span class=n>stream</span><span class=p>:</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a>        <span class=k>if</span> <span class=n>state</span><span class=o>.</span><span class=n>step</span> <span class=o>%</span> <span class=mi>50</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a>            <span class=n>p</span> <span class=o>=</span> <span class=n>stream</span><span class=o>.</span><span class=n>progress</span><span class=p>()</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a>            <span class=nb>print</span><span class=p>(</span>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a>                <span class=sa>f</span><span class=s2>&quot;Yielded: </span><span class=si>{</span><span class=n>p</span><span class=p>[</span><span class=s1>&#39;yield_count&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>, &quot;</span>
</span><span id=__span-15-7><a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a>                <span class=sa>f</span><span class=s2>&quot;Saved: </span><span class=si>{</span><span class=n>p</span><span class=p>[</span><span class=s1>&#39;saved_count&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>, &quot;</span>
</span><span id=__span-15-8><a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a>                <span class=sa>f</span><span class=s2>&quot;Checkpoints: </span><span class=si>{</span><span class=n>p</span><span class=p>[</span><span class=s1>&#39;checkpoints_count&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>, &quot;</span>
</span><span id=__span-15-9><a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a>                <span class=sa>f</span><span class=s2>&quot;Pending: </span><span class=si>{</span><span class=n>p</span><span class=p>[</span><span class=s1>&#39;batch_pending&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>, &quot;</span>
</span><span id=__span-15-10><a id=__codelineno-15-10 name=__codelineno-15-10 href=#__codelineno-15-10></a>                <span class=sa>f</span><span class=s2>&quot;Memory: </span><span class=si>{</span><span class=n>p</span><span class=p>[</span><span class=s1>&#39;memory_usage&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2> MB&quot;</span>
</span><span id=__span-15-11><a id=__codelineno-15-11 name=__codelineno-15-11 href=#__codelineno-15-11></a>            <span class=p>)</span>
</span></code></pre></div> <p>The returned dictionary contains:</p> <table> <thead> <tr> <th>Key</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>yield_count</code></td> <td><code>int</code></td> <td>Total states yielded (including replays)</td> </tr> <tr> <td><code>saved_count</code></td> <td><code>int</code></td> <td>Total states written to store</td> </tr> <tr> <td><code>checkpoints_count</code></td> <td><code>int</code></td> <td>Total checkpoints created</td> </tr> <tr> <td><code>batch_pending</code></td> <td><code>int</code></td> <td>States in current batch (not yet flushed)</td> </tr> <tr> <td><code>store_backend</code></td> <td><code>str</code> or <code>None</code></td> <td>Name of the store class being used</td> </tr> <tr> <td><code>memory_usage</code></td> <td><code>float</code></td> <td>Estimated batch memory in MB</td> </tr> </tbody> </table> <p>When <code>background_io=True</code>, two additional keys are available: <code>io_queue_size</code> (current items in the I/O queue) and <code>io_thread_alive</code> (whether the background thread is running).</p> <h3 id=properties>Properties<a class=headerlink href=#properties title="Permanent link">&para;</a></h3> <p>The stream also exposes several read-only properties for quick status checks:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=n>stream</span><span class=o>.</span><span class=n>yield_count</span>       <span class=c1># Total states yielded so far</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=n>stream</span><span class=o>.</span><span class=n>saved_count</span>       <span class=c1># Total states saved to store</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=n>stream</span><span class=o>.</span><span class=n>checkpoints_count</span> <span class=c1># Total checkpoints created</span>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=n>stream</span><span class=o>.</span><span class=n>is_consumed</span>       <span class=c1># Whether the underlying generator is exhausted</span>
</span></code></pre></div> <hr> <h2 id=background-io>Background I/O<a class=headerlink href=#background-io title="Permanent link">&para;</a></h2> <p>When <code>background_io=True</code>, disk writes happen in a separate thread, allowing the simulation to continue while data is being written. This provides a 2 to 3x speedup when I/O is slower than the simulation itself. The simulation thread fills a queue; the I/O worker thread drains it.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=k>with</span> <span class=n>StateStream</span><span class=p>(</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a>    <span class=n>states</span><span class=o>=</span><span class=n>bores</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>config</span><span class=p>),</span>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a>    <span class=n>store</span><span class=o>=</span><span class=n>ZarrStore</span><span class=p>(</span><span class=s2>&quot;run.zarr&quot;</span><span class=p>),</span>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a>    <span class=n>background_io</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a>    <span class=n>max_queue_size</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span>
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a><span class=p>)</span> <span class=k>as</span> <span class=n>stream</span><span class=p>:</span>
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a>    <span class=k>for</span> <span class=n>state</span> <span class=ow>in</span> <span class=n>stream</span><span class=p>:</span>
</span><span id=__span-17-8><a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a>        <span class=n>analyze</span><span class=p>(</span><span class=n>state</span><span class=p>)</span>
</span></code></pre></div> <p>The <code>max_queue_size</code> parameter limits the number of batches waiting to be written. When the queue is full, the simulation thread blocks until the I/O worker drains an item. This back-pressure mechanism prevents unbounded memory growth when the simulation produces states faster than they can be written to disk. If the I/O worker encounters an error, the exception is re-raised on the next iteration of the simulation loop so you do not silently lose data.</p> <hr> <h2 id=selective-saving>Selective Saving<a class=headerlink href=#selective-saving title="Permanent link">&para;</a></h2> <p>You can filter which states are saved using a predicate function passed to the <code>save</code> parameter. All states are still yielded to your code, but only those matching the predicate are persisted.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=c1># Save every 10th state</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=k>with</span> <span class=n>StateStream</span><span class=p>(</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a>    <span class=n>states</span><span class=o>=</span><span class=n>bores</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>config</span><span class=p>),</span>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a>    <span class=n>store</span><span class=o>=</span><span class=n>store</span><span class=p>,</span>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a>    <span class=n>save</span><span class=o>=</span><span class=k>lambda</span> <span class=n>s</span><span class=p>:</span> <span class=n>s</span><span class=o>.</span><span class=n>step</span> <span class=o>%</span> <span class=mi>10</span> <span class=o>==</span> <span class=mi>0</span><span class=p>,</span>
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a><span class=p>)</span> <span class=k>as</span> <span class=n>stream</span><span class=p>:</span>
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a>    <span class=k>for</span> <span class=n>state</span> <span class=ow>in</span> <span class=n>stream</span><span class=p>:</span>
</span><span id=__span-18-8><a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a>        <span class=k>pass</span>  <span class=c1># All states yielded, but only every 10th saved</span>
</span></code></pre></div> <p>You can also disable saving entirely by passing <code>save=False</code>. The stream will still iterate through all states but will not write anything to the store.</p> <hr> <h2 id=checkpointing>Checkpointing<a class=headerlink href=#checkpointing title="Permanent link">&para;</a></h2> <p>For long-running simulations, checkpointing saves the state at regular intervals to a separate store, enabling crash recovery. Checkpoints are written to a dedicated <code>checkpoint_store</code> independently of the main store.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=k>with</span> <span class=n>StateStream</span><span class=p>(</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a>    <span class=n>states</span><span class=o>=</span><span class=n>bores</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>config</span><span class=p>),</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a>    <span class=n>store</span><span class=o>=</span><span class=n>ZarrStore</span><span class=p>(</span><span class=s2>&quot;full_run.zarr&quot;</span><span class=p>),</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a>    <span class=n>checkpoint_store</span><span class=o>=</span><span class=n>ZarrStore</span><span class=p>(</span><span class=s2>&quot;checkpoints.zarr&quot;</span><span class=p>),</span>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a>    <span class=n>checkpoint_interval</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a><span class=p>)</span> <span class=k>as</span> <span class=n>stream</span><span class=p>:</span>
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a>    <span class=k>for</span> <span class=n>state</span> <span class=ow>in</span> <span class=n>stream</span><span class=p>:</span>
</span><span id=__span-19-8><a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a>        <span class=k>pass</span>
</span></code></pre></div> <p>If the simulation crashes at step 450, the checkpoint store contains the state at steps 100, 200, 300, and 400 (checkpointing starts at step 1, not step 0).</p> <h3 id=accessing-checkpoints>Accessing Checkpoints<a class=headerlink href=#accessing-checkpoints title="Permanent link">&para;</a></h3> <p>The stream provides methods for working with checkpoints:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=c1># List available checkpoint step numbers</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=n>available</span> <span class=o>=</span> <span class=n>stream</span><span class=o>.</span><span class=n>list_checkpoints</span><span class=p>()</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Checkpoints at steps: </span><span class=si>{</span><span class=n>available</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a><span class=c1># Load a specific checkpoint by step number</span>
</span><span id=__span-20-6><a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a><span class=n>state_at_200</span> <span class=o>=</span> <span class=n>stream</span><span class=o>.</span><span class=n>checkpoint</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span><span id=__span-20-7><a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a>
</span><span id=__span-20-8><a id=__codelineno-20-8 name=__codelineno-20-8 href=#__codelineno-20-8></a><span class=c1># Iterate over all checkpoints</span>
</span><span id=__span-20-9><a id=__codelineno-20-9 name=__codelineno-20-9 href=#__codelineno-20-9></a><span class=k>for</span> <span class=n>checkpoint_state</span> <span class=ow>in</span> <span class=n>stream</span><span class=o>.</span><span class=n>checkpoints</span><span class=p>():</span>
</span><span id=__span-20-10><a id=__codelineno-20-10 name=__codelineno-20-10 href=#__codelineno-20-10></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Checkpoint at step </span><span class=si>{</span><span class=n>checkpoint_state</span><span class=o>.</span><span class=n>step</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span></code></pre></div> <hr> <h2 id=idiomatic-patterns>Idiomatic Patterns<a class=headerlink href=#idiomatic-patterns title="Permanent link">&para;</a></h2> <h3 id=run-save-and-analyze>Run, Save, and Analyze<a class=headerlink href=#run-save-and-analyze title="Permanent link">&para;</a></h3> <p>The most common workflow is to run a simulation with streaming persistence, then analyze the saved results:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=kn>import</span><span class=w> </span><span class=nn>bores</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a><span class=kn>from</span><span class=w> </span><span class=nn>bores.stores</span><span class=w> </span><span class=kn>import</span> <span class=n>ZarrStore</span>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=kn>from</span><span class=w> </span><span class=nn>bores.streams</span><span class=w> </span><span class=kn>import</span> <span class=n>StateStream</span>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a><span class=kn>from</span><span class=w> </span><span class=nn>bores.analyses</span><span class=w> </span><span class=kn>import</span> <span class=n>ModelAnalyst</span>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a>
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a><span class=n>store</span> <span class=o>=</span> <span class=n>ZarrStore</span><span class=p>(</span><span class=s2>&quot;simulation.zarr&quot;</span><span class=p>)</span>
</span><span id=__span-21-7><a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a><span class=k>with</span> <span class=n>StateStream</span><span class=p>(</span>
</span><span id=__span-21-8><a id=__codelineno-21-8 name=__codelineno-21-8 href=#__codelineno-21-8></a>    <span class=n>states</span><span class=o>=</span><span class=n>bores</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>config</span><span class=p>),</span>
</span><span id=__span-21-9><a id=__codelineno-21-9 name=__codelineno-21-9 href=#__codelineno-21-9></a>    <span class=n>store</span><span class=o>=</span><span class=n>store</span><span class=p>,</span>
</span><span id=__span-21-10><a id=__codelineno-21-10 name=__codelineno-21-10 href=#__codelineno-21-10></a>    <span class=n>background_io</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-21-11><a id=__codelineno-21-11 name=__codelineno-21-11 href=#__codelineno-21-11></a><span class=p>)</span> <span class=k>as</span> <span class=n>stream</span><span class=p>:</span>
</span><span id=__span-21-12><a id=__codelineno-21-12 name=__codelineno-21-12 href=#__codelineno-21-12></a>    <span class=n>stream</span><span class=o>.</span><span class=n>consume</span><span class=p>()</span>  <span class=c1># Save everything, process nothing</span>
</span><span id=__span-21-13><a id=__codelineno-21-13 name=__codelineno-21-13 href=#__codelineno-21-13></a>
</span><span id=__span-21-14><a id=__codelineno-21-14 name=__codelineno-21-14 href=#__codelineno-21-14></a><span class=c1># Analyze saved results</span>
</span><span id=__span-21-15><a id=__codelineno-21-15 name=__codelineno-21-15 href=#__codelineno-21-15></a><span class=kn>from</span><span class=w> </span><span class=nn>bores.states</span><span class=w> </span><span class=kn>import</span> <span class=n>ModelState</span>
</span><span id=__span-21-16><a id=__codelineno-21-16 name=__codelineno-21-16 href=#__codelineno-21-16></a><span class=n>analyst</span> <span class=o>=</span> <span class=n>ModelAnalyst</span><span class=p>(</span><span class=n>store</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>ModelState</span><span class=p>))</span>
</span><span id=__span-21-17><a id=__codelineno-21-17 name=__codelineno-21-17 href=#__codelineno-21-17></a><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Recovery factor: </span><span class=si>{</span><span class=n>analyst</span><span class=o>.</span><span class=n>oil_recovery_factor</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span></code></pre></div> <h3 id=monitor-during-simulation>Monitor During Simulation<a class=headerlink href=#monitor-during-simulation title="Permanent link">&para;</a></h3> <p>If you want to process states as they arrive while also saving them:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=k>with</span> <span class=n>StateStream</span><span class=p>(</span><span class=n>states</span><span class=o>=</span><span class=n>bores</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>config</span><span class=p>),</span> <span class=n>store</span><span class=o>=</span><span class=n>store</span><span class=p>)</span> <span class=k>as</span> <span class=n>stream</span><span class=p>:</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a>    <span class=k>for</span> <span class=n>state</span> <span class=ow>in</span> <span class=n>stream</span><span class=p>:</span>
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a>        <span class=k>if</span> <span class=n>state</span><span class=o>.</span><span class=n>step</span> <span class=o>%</span> <span class=mi>10</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a>            <span class=n>p</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>fluid_properties</span><span class=o>.</span><span class=n>pressure_grid</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span><span id=__span-22-5><a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Step </span><span class=si>{</span><span class=n>state</span><span class=o>.</span><span class=n>step</span><span class=si>}</span><span class=s2>: P_avg = </span><span class=si>{</span><span class=n>p</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2> psi&quot;</span><span class=p>)</span>
</span></code></pre></div> <h3 id=early-stopping>Early Stopping<a class=headerlink href=#early-stopping title="Permanent link">&para;</a></h3> <p>Use <code>until()</code> or <code>while_()</code> to stop the simulation when a physical criterion is met:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=k>with</span> <span class=n>StateStream</span><span class=p>(</span><span class=n>states</span><span class=o>=</span><span class=n>bores</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>config</span><span class=p>),</span> <span class=n>store</span><span class=o>=</span><span class=n>store</span><span class=p>)</span> <span class=k>as</span> <span class=n>stream</span><span class=p>:</span>
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a>    <span class=c1># Stop when water cut exceeds 95%</span>
</span><span id=__span-23-3><a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a>    <span class=n>final</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-23-4><a id=__codelineno-23-4 name=__codelineno-23-4 href=#__codelineno-23-4></a>    <span class=k>for</span> <span class=n>state</span> <span class=ow>in</span> <span class=n>stream</span><span class=o>.</span><span class=n>until</span><span class=p>(</span>
</span><span id=__span-23-5><a id=__codelineno-23-5 name=__codelineno-23-5 href=#__codelineno-23-5></a>        <span class=k>lambda</span> <span class=n>s</span><span class=p>:</span> <span class=p>(</span><span class=n>s</span><span class=o>.</span><span class=n>production</span><span class=o>.</span><span class=n>water</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span> <span class=o>/</span> <span class=nb>max</span><span class=p>(</span><span class=n>s</span><span class=o>.</span><span class=n>production</span><span class=o>.</span><span class=n>oil</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span> <span class=o>+</span> <span class=n>s</span><span class=o>.</span><span class=n>production</span><span class=o>.</span><span class=n>water</span><span class=o>.</span><span class=n>sum</span><span class=p>(),</span> <span class=mf>1e-10</span><span class=p>))</span> <span class=o>&gt;</span> <span class=mf>0.95</span>
</span><span id=__span-23-6><a id=__codelineno-23-6 name=__codelineno-23-6 href=#__codelineno-23-6></a>    <span class=p>):</span>
</span><span id=__span-23-7><a id=__codelineno-23-7 name=__codelineno-23-7 href=#__codelineno-23-7></a>        <span class=n>final</span> <span class=o>=</span> <span class=n>state</span>
</span></code></pre></div> <h3 id=sparse-replay>Sparse Replay<a class=headerlink href=#sparse-replay title="Permanent link">&para;</a></h3> <p>When analyzing long simulations, load only the states you need:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=c1># Every 50th step for trend analysis</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a><span class=n>analyst</span> <span class=o>=</span> <span class=n>ModelAnalyst</span><span class=p>(</span><span class=n>stream</span><span class=o>.</span><span class=n>replay</span><span class=p>(</span><span class=n>steps</span><span class=o>=</span><span class=k>lambda</span> <span class=n>s</span><span class=p>:</span> <span class=n>s</span> <span class=o>%</span> <span class=mi>50</span> <span class=o>==</span> <span class=mi>0</span><span class=p>))</span>
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a><span class=c1># First and last only for delta comparison</span>
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a><span class=n>initial</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=n>stream</span><span class=o>.</span><span class=n>replay</span><span class=p>(</span><span class=n>indices</span><span class=o>=</span><span class=p>[</span><span class=mi>0</span><span class=p>]))</span>
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a><span class=n>final</span> <span class=o>=</span> <span class=n>stream</span><span class=o>.</span><span class=n>last</span><span class=p>()</span>
</span></code></pre></div> <h3 id=get-just-the-final-state>Get Just the Final State<a class=headerlink href=#get-just-the-final-state title="Permanent link">&para;</a></h3> <p>When you only care about the end result:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=n>stream</span> <span class=o>=</span> <span class=n>StateStream</span><span class=p>(</span><span class=n>states</span><span class=o>=</span><span class=n>bores</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>config</span><span class=p>),</span> <span class=n>store</span><span class=o>=</span><span class=n>store</span><span class=p>)</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a><span class=n>final_state</span> <span class=o>=</span> <span class=n>stream</span><span class=o>.</span><span class=n>last</span><span class=p>()</span>
</span></code></pre></div> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../aquifers/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Aquifer Modeling"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Aquifer Modeling </div> </div> </a> <a href=../model-analysis/ class="md-footer__link md-footer__link--next" aria-label="Next: Model Analysis"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Model Analysis </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2025 ti-oluwa </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/ti-oluwa target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://pypi.org/project/bores-framework/ target=_blank rel=noopener title=pypi.org class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 444.7a20.4 20.4 0 1 1 0-40.7 20.4 20.4 0 1 1 0 40.7M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.6-183.4a20.4 20.4 0 1 1 0 40.8 20.4 20.4 0 1 1 0-40.8"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"annotate": null, "base": "../../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.tabs.link", "content.tooltips", "navigation.expand", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script> <script src=../../../assets/javascripts/bundle.79ae519e.min.js></script> <script src=../../../javascripts/mathjax.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> </body> </html>